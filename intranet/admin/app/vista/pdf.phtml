<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="es">
<!--<![endif]-->

<head>
  <?php include("head.php"); ?>
  <link rel="stylesheet" href="<?php echo ruta ?>app/css/geofal-redesign.css">
</head>

<body>
  <!-- Left Panel -->
  <?php include("header_left.php"); ?>

  <div id="right-panel" class="right-panel">
    <!-- Header-->
    <?php include("header_top.php"); ?>

    <!-- Botón Volver -->
    <div class="back-button-section">
      <a href="<?= ruta ?>?pagina=clientes" class="btn-volver">
        <i class="fa fa-arrow-left"></i> <span>Volver</span>
      </a>
    </div>

    <!-- Header Section - Título, Botón y Búsqueda en una línea -->
    <div class="pdf-header-section">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12">
            <div class="pdf-header-container">
              <!-- Título de la Empresa (Botón Azul) - IZQUIERDA -->
              <?php if (isset($razon_social) && !empty($razon_social)): ?>
                <div class="empresa-title-button">
                  <button type="button" class="btn-empresa-title">
                    <?php echo strtoupper(htmlspecialchars($razon_social)) ?>
                  </button>
                </div>
              <?php endif; ?>
              
              <!-- Botón y Búsqueda agrupados a la DERECHA -->
              <div class="pdf-header-actions">
                <!-- Botón Agregar PDF (Verde) -->
                <div class="add-button-container">
                  <a href="<?= ruta ?>?pagina=pdf_agregar&id=<?php echo $_GET['id'] ?>" class="btn-add-pdf-verde">
                    <i class="fa fa-plus"></i> Agregar Nuevo PDF
                  </a>
                </div>
                
                <!-- Barra de búsqueda -->
                <form action="<?= ruta ?>" method="get" class="search-form">
                  <input type="hidden" name="pagina" value="<?php echo $_GET['pagina'] ?>">
                  <input type="hidden" name="id" value="<?php echo $_GET['id'] ?>">
                  <input type="hidden" name="p" value="1">
                  <div class="input-group-search">
                    <?php if (!empty($_GET['b']) and isset($_GET['b'])): ?>
                      <a href="<?= ruta ?>?pagina=<?php echo $_GET['pagina'] ?>&id=<?php echo $_GET['id'] ?>" class="btn btn-outline-secondary btn-todos">Todos</a>
                    <?php endif; ?>
                    <input type="text" class="form-control-search" name="b" placeholder="Buscar PDF" value="<?php echo $get_b2 ?>">
                    <button class="btn btn-search" type="submit">
                      <i class="fa fa-search"></i>
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-empresas-geofal">
                  <thead>
                    <tr>
                      <th>ACCIÓN</th>
                      <th>TÍTULO</th>
                      <th>ESTADO</th>
                      <th>FECHA SUBIDA</th>
                    </tr>
                  </thead>
                  <tbody>
                    <?php if (empty($mostrar_pdf_pagi) || count($mostrar_pdf_pagi) == 0): ?>
                      <tr>
                        <td colspan="4" style="text-align: center; padding: 40px; color: var(--gray-500);">
                          No hay PDFs registrados
                        </td>
                      </tr>
                    <?php else: ?>
                      <?php foreach ($mostrar_pdf_pagi as $m_pdf): ?>
                        <tr id="eli<?php echo $m_pdf['id'] ?>">
                          <td>
                            <div class="btn-group-actions">
                              <a href="<?= ruta ?>?pagina=pdf_editar&id=<?php echo $m_pdf['id'] ?>" class="btn btn-outline-primary btn-sm" title="Editar">
                                <i class="fa fa-pencil"></i>
                              </a>
                              <a href="#" onclick="eliminar_todo('<?php echo ruta ?>?pagina=pdf&id=<?php echo $_GET['id'] ?>','<?php echo $m_pdf['id'] ?>','eliminar_pdf')" class="btn btn-danger btn-sm" title="Eliminar">
                                <i class="fa fa-trash-o"></i>
                              </a>
                            </div>
                          </td>
                          <td><?php echo htmlspecialchars($m_pdf['titulo']) ?></td>
                          <td class="estado-cell">
                            <?php 
                            // Estado según especificaciones: "No leído" (rojo) o "Descargado" (verde)
                            // Si tiene estado 1 o vista 1, está descargado
                            if (($m_pdf['estado'] == '1' || $m_pdf['vista'] == '1')): 
                            ?>
                              <span class="badge-estado badge-descargado">Descargado</span>
                            <?php else: ?>
                              <span class="badge-estado badge-no-leido">No leído</span>
                            <?php endif; ?>
                          </td>
                          <td class="fecha-subida-cell">
                            <?php 
                            // Mostrar fecha de subida si existe, solo fecha (día/mes/año)
                            if (isset($m_pdf['fecha_subida']) && !empty($m_pdf['fecha_subida'])) {
                              $fecha_subida = date('d/m/Y', strtotime($m_pdf['fecha_subida']));
                              echo '<span class="fecha-subida">' . $fecha_subida . '</span>';
                            } else {
                              // Si no hay fecha_subida, mostrar "N/A"
                              echo '<span class="fecha-subida">N/A</span>';
                            }
                            ?>
                          </td>
                        </tr>
                      <?php endforeach; ?>
                    <?php endif; ?>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <?php include("footer.php"); ?>
  
  <script>
    // Mostrar notificaciones de éxito
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const success = urlParams.get('success');
      
      if (success === 'pdf_agregado') {
        Swal.fire({
          icon: 'success',
          title: '¡Éxito!',
          text: 'El PDF se ha agregado correctamente',
          timer: 3000,
          timerProgressBar: true,
          showConfirmButton: false
        });
        // Limpiar parámetro de la URL
        window.history.replaceState({}, document.title, window.location.pathname + window.location.search.replace(/[?&]success=[^&]+/, '').replace(/^&/, '?'));
      } else if (success === 'pdf_editado') {
        Swal.fire({
          icon: 'success',
          title: '¡Éxito!',
          text: 'El PDF se ha actualizado correctamente',
          timer: 3000,
          timerProgressBar: true,
          showConfirmButton: false
        });
        window.history.replaceState({}, document.title, window.location.pathname + window.location.search.replace(/[?&]success=[^&]+/, '').replace(/^&/, '?'));
      }
    });
  </script>
</body>
</html>
